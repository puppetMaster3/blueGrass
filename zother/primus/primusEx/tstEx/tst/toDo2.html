<html><head></head><body>
<!-- html form with one field called todo_item: -->
<form id='formId'><fieldset>
    <label for='item'>Item:</label>

    <input name='todo_item'  id= 'item'  size='40' />

    <button id='addBut' onclick='return false'>Add</button>
    <button id='upBut'  onclick='return false'>Update</button>
    <button id='delBut' onclick='return false'>Delete</button>

    <label id='pk'></label>
</fieldset></form>
<!-- template : (3rd party) -->
<div id='todo-list'>
    <ul class='template'></ul>
</div>
<!-- example imports (some popular 3rd party libs, use any version of jquery) : -->
<script src='http://code.jquery.com/jquery-2.0.0.min.js '></script>
<script src='cookies.js'></script>
<script src='http://f6.backendZero.com/acdn/libs/list.js'></script>

<!-- get the lib -->
<script src='http://ca_1.primusapi.com/acdn/libs/cloudAPI.js'></script>
<script>


// example of cloud functions 'CRUD'
// start code:init the CloudAPI *** PUT YOUR KEY HERE ***
var cloud = new CloudAPI("fisvhiad2ir")


$(document).ready(function () {// map mouse events:
    document.querySelector('#addBut').addEventListener('click', onAddClicked)
    document.querySelector('#upBut'). addEventListener('click', onUpClicked)
    document.querySelector('#delBut').addEventListener('click', onDelClicked)

    setupBrowserCookie()

    doSelect()

    //cloud.selectAll('todo2', onSelectRet)// call
})//()


function setupBrowserCookie() { // a version of code of per user client side
    var browser =  navigator.vendor
    browser = browser.substr(0,1)
    console.log(browser)
    userNo = Cookies.get('user')
    try {
        console.log(userNo)
        console.log('old user')
        userNo = userNo + browser
    } catch(err) {
        console.log('new user')
        userNo = Math.floor(Math.random()*100) +''
        console.log(userNo)
        Cookies.set('user', userNo, { expires: 31 * 24 * 360 * 1000 }) // 1 hour * 31 days
        userNo = userNo + browser
    }

    console.log(userNo)

}

function doSelect() {
    var msg = new Object()
    msg.user = userNo
    cloud.select('todo2', msg, onSelectRet)

}


// click event handlers
function onAddClicked() {
    var msg = cloud.makeFormMessage('formId') // helper method to make a msg, any Object could do, dynamic fields and table name
    msg.user = userNo
    console.log(JSON.stringify(msg))
    cloud.insert('todo2', msg, onRet)
}

function onUpClicked() {
    console.log('up')
    var msg = new Object()
    msg.todo_item =  $('#item').val()
    msg.user = userNo
    cloud.update('todo2',dat._id,msg,onRet)
}

function onDelClicked() {
    console.log('del' )
    cloud.del('todo2',dat._id,onRet)
}

function onRet(data, errorMsg) { // after data has been changed
    $('#item').val('')
    $('#pk').text('')
    dat = null
    console.log('changed ' +  JSON.stringify(data) +' errorStringIfAny:' + errorMsg)
    doSelect()
    //cloud.selectAll('todo2', onSelectRet)      // see docs on selectAll
    doSelect()
}

function onSelectRet(data, errorMsg) { // we have now returned a list of rows
    console.log('selected ')
    console.log( JSON.stringify(data) )
    list=new List('todo-list', map, data.array_ ) //data bind to template
    list.sort('_daoc', { asc: false })   // date-time as long
}

function onRowClicked(evt) {
    var rows = list.search( evt)
    list.search()// hack
    dat = rows[0].values()
    console.log(dat._id)
    $('#item').val(dat.todo_item)
    $('#pk').text(dat._id)
}

var map = { // example config template (3rd party)                                               _daoc
    item:  "<div > <a href='#'><span onclick=onRowClicked(this.innerText) class='_id'></span></a> <span class='_daoc'></span> <b><span class='todo_item'></span></b> </div>"
    ,listClass : 'template'
}
 </script>
</body></html>